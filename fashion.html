<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI 패션 추천 — SEOULFIT</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+KR:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f7f4;--fg:#0a0a0a;--blue:#1a56ff;--blue-dim:rgba(26,86,255,.07);
  --border:rgba(10,10,10,.1);--red:#e02020;
  --f-disp:'Bebas Neue',sans-serif;--f-body:'Noto Sans KR',sans-serif;--f-mono:'DM Mono',monospace;
}
html,body{background:var(--bg);color:var(--fg);font-family:var(--f-body);min-height:100vh;cursor:none;overflow-x:hidden}

/* cursor */
#cr{position:fixed;top:0;left:0;z-index:9999;width:28px;height:28px;border:1.5px solid var(--fg);border-radius:50%;pointer-events:none;transform:translate(-50%,-50%);transition:width .22s,height .22s,border-radius .22s,border-color .22s,background .22s;mix-blend-mode:multiply}
#cd{position:fixed;top:0;left:0;z-index:10000;width:5px;height:5px;background:var(--blue);border-radius:50%;pointer-events:none;transform:translate(-50%,-50%)}
.ch #cr{width:48px;height:48px;border-color:var(--blue);background:var(--blue-dim);border-radius:4px}

/* transitions */
#reveal{position:fixed;inset:0;z-index:5000;background:var(--fg);transform-origin:top;animation:revealOut .6s cubic-bezier(.76,0,.24,1) .1s forwards}
@keyframes revealOut{0%{transform:scaleY(1)}100%{transform:scaleY(0)}}
#trans{position:fixed;inset:0;z-index:6000;background:var(--fg);transform:scaleY(0);transform-origin:bottom;pointer-events:none}
#trans.go{animation:transGo .55s cubic-bezier(.76,0,.24,1) forwards}
@keyframes transGo{to{transform:scaleY(1)}}
#trans-lbl{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:var(--f-disp);font-size:1.8rem;letter-spacing:.2em;color:#fff;opacity:0;transition:opacity .2s .25s}
#trans.go #trans-lbl{opacity:1}

/* header */
header{position:fixed;top:0;left:0;right:0;z-index:400;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 40px;background:rgba(248,247,244,.94);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.hd-logo{font-family:var(--f-disp);font-size:1.2rem;letter-spacing:.2em;color:var(--fg);text-decoration:none}
.hd-logo em{color:var(--blue);font-style:normal}
.hd-back{font-family:var(--f-mono);font-size:.52rem;letter-spacing:.15em;color:rgba(10,10,10,.4);background:none;border:none;cursor:none;transition:color .2s;display:flex;align-items:center;gap:8px}
.hd-back:hover{color:var(--fg)}
.hd-tag{font-family:var(--f-mono);font-size:.48rem;letter-spacing:.15em;color:var(--blue);text-transform:uppercase}

/* hero */
.hero{padding:130px 12vw 60px;display:flex;align-items:flex-end;justify-content:space-between;gap:40px;flex-wrap:wrap}
.hero-title{font-family:var(--f-disp);font-size:clamp(4rem,8vw,9rem);line-height:.88;letter-spacing:-.01em}
.hero-title em{color:var(--blue);font-style:normal}
.hero-sub{font-size:.75rem;line-height:2;color:rgba(10,10,10,.45);max-width:300px;letter-spacing:.02em}

/* 환율 뱃지 */
#rate-badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 14px;margin-top:12px;font-family:var(--f-mono);font-size:.44rem;letter-spacing:.1em;color:rgba(10,10,10,.4)}
#rate-badge .live-dot{width:5px;height:5px;border-radius:50%;background:#22c55e;animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* divider */
.divider{height:1px;background:var(--border);margin:0 12vw}

/* layout */
.section{padding:52px 12vw;display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:start}
@media(max-width:900px){.section{grid-template-columns:1fr;padding:40px 6vw}.hero{padding:120px 6vw 48px}}

/* form */
.f-label{font-family:var(--f-mono);font-size:.48rem;letter-spacing:.25em;color:var(--blue);text-transform:uppercase;margin-bottom:10px}
.f-input{width:100%;background:transparent;border:none;border-bottom:1.5px solid var(--border);padding:10px 0;font-family:var(--f-mono);font-size:.72rem;letter-spacing:.06em;color:var(--fg);outline:none;transition:border-color .2s;margin-bottom:20px;cursor:none}
.f-input:focus{border-color:var(--blue)}
.f-input::placeholder{color:rgba(10,10,10,.2)}
.f-row{display:flex;gap:16px}
.f-row .f-input{flex:1}

/* 이메일 박스 */
.email-wrap{background:var(--blue-dim);border:1.5px solid rgba(26,86,255,.2);padding:14px 16px;margin-bottom:24px}
.email-wrap .f-input{border-bottom-color:rgba(26,86,255,.25);margin-bottom:0}
.email-wrap .f-input:focus{border-color:var(--blue)}
.email-note{font-family:var(--f-mono);font-size:.42rem;letter-spacing:.06em;color:rgba(26,86,255,.5);margin-top:6px}

/* tags */
.tag-group{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:24px}
.tag{font-family:var(--f-mono);font-size:.5rem;letter-spacing:.1em;border:1.5px solid var(--border);padding:6px 14px;cursor:none;transition:all .2s;color:rgba(10,10,10,.4);background:transparent}
.tag:hover,.tag.on{border-color:var(--blue);color:var(--fg);background:var(--blue-dim)}

/* submit */
.submit-btn{font-family:var(--f-disp);font-size:.9rem;letter-spacing:.28em;color:#fff;background:var(--blue);border:none;padding:14px 40px;cursor:none;width:100%;transition:opacity .2s;margin-top:8px}
.submit-btn:hover{opacity:.85}
.submit-btn:disabled{opacity:.4}

/* ── result ───────────────────────────────────────────────── */
.result-col{min-height:200px}

/* 아이돌 배너 */
.idol-banner{border:1.5px solid rgba(26,86,255,.18);background:var(--blue-dim);padding:18px 20px;margin-bottom:20px}
.idol-banner-kw{font-family:var(--f-mono);font-size:.42rem;letter-spacing:.25em;color:var(--blue);text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.idol-banner-text{font-size:.78rem;line-height:1.9;color:rgba(10,10,10,.55)}

/* 섹션 구분 */
.sec-label{font-family:var(--f-mono);font-size:.44rem;letter-spacing:.22em;text-transform:uppercase;padding:8px 0;border-bottom:1px solid var(--border);margin:20px 0 12px;display:flex;align-items:center;gap:10px}
.sec-label.kr{color:var(--blue)}
.sec-label.other{color:rgba(10,10,10,.32)}

.r-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.r-title{font-family:var(--f-disp);font-size:1.5rem;letter-spacing:.06em}
.r-count{font-family:var(--f-mono);font-size:.5rem;letter-spacing:.15em;color:rgba(10,10,10,.3)}

/* 상품 카드 */
.prod-card{border:1.5px solid var(--border);margin-bottom:10px;overflow:hidden;transition:border-color .25s;position:relative}
.prod-card:hover{border-color:rgba(26,86,255,.35)}
.prod-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--blue);transform:scaleY(0);transform-origin:bottom;transition:transform .25s}
.prod-card:hover::before{transform:scaleY(1)}

.prod-inner{display:flex;align-items:stretch}

/* 이미지 박스 (무신사 실제 이미지) */
.prod-img{width:96px;flex-shrink:0;position:relative;overflow:hidden;min-height:120px;background:#ececec}
.prod-img img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
.prod-img-ph{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--f-mono);font-size:.38rem;letter-spacing:.06em;color:rgba(10,10,10,.22);text-align:center;line-height:1.5;padding:8px}
.kr-badge{position:absolute;top:6px;left:6px;background:var(--blue);color:#fff;font-family:var(--f-mono);font-size:.36rem;letter-spacing:.06em;padding:2px 6px;z-index:2}
.musinsa-badge{position:absolute;bottom:6px;left:6px;background:rgba(10,10,10,.65);color:#fff;font-family:var(--f-mono);font-size:.34rem;letter-spacing:.04em;padding:2px 5px;z-index:2;backdrop-filter:blur(4px)}

.prod-body{flex:1;padding:13px 13px 13px 15px;display:flex;flex-direction:column;justify-content:space-between;min-width:0}
.prod-brand{font-family:var(--f-disp);font-size:1.05rem;letter-spacing:.05em;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.prod-name{font-size:.74rem;color:var(--fg);margin-bottom:5px;line-height:1.4;font-weight:500;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.prod-desc{font-size:.67rem;line-height:1.75;color:rgba(10,10,10,.42);margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.prod-tags{display:flex;flex-wrap:wrap;gap:4px}
.prod-tag{font-family:var(--f-mono);font-size:.4rem;letter-spacing:.06em;color:rgba(10,10,10,.3);border:1px solid var(--border);padding:2px 7px}

.prod-price-col{padding:13px;display:flex;flex-direction:column;align-items:flex-end;justify-content:space-between;flex-shrink:0;min-width:80px}
.prod-price-jpy{font-family:var(--f-disp);font-size:1.45rem;letter-spacing:.02em;color:var(--blue);white-space:nowrap}
.prod-price-krw{font-family:var(--f-mono);font-size:.4rem;letter-spacing:.06em;color:rgba(10,10,10,.22);white-space:nowrap;margin-top:2px}

/* 구매 바 */
.prod-buy-bar{border-top:1px solid var(--border);display:flex}
.prod-buy{flex:1;font-family:var(--f-disp);font-size:.8rem;letter-spacing:.22em;color:var(--fg);background:transparent;border:none;padding:11px 14px;cursor:none;text-align:left;transition:background .2s,color .2s;display:flex;align-items:center;justify-content:space-between}
.prod-buy:hover{background:var(--blue);color:#fff}
.prod-buy span{font-family:var(--f-mono);font-size:.42rem;letter-spacing:.06em;opacity:.45}
.prod-view{width:52px;border-left:1px solid var(--border);display:flex;align-items:center;justify-content:center;text-decoration:none;font-family:var(--f-mono);font-size:.38rem;letter-spacing:.04em;color:rgba(10,10,10,.35);transition:background .2s,color .2s;flex-shrink:0}
.prod-view:hover{background:rgba(10,10,10,.06);color:var(--fg)}

/* 해외브랜드 이미지 플레이스홀더 */
.brand-initial{width:96px;height:100%;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--fg);color:#fff;font-family:var(--f-disp);font-size:1.8rem;letter-spacing:.04em;flex-shrink:0}
.brand-initial small{font-family:var(--f-mono);font-size:.35rem;letter-spacing:.08em;opacity:.4;margin-top:4px;text-transform:uppercase}

/* loading skeleton */
.skeleton{background:linear-gradient(90deg,rgba(10,10,10,.04) 25%,rgba(10,10,10,.09) 50%,rgba(10,10,10,.04) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:2px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* info/error box */
.info-box{border:1.5px solid rgba(26,86,255,.15);background:var(--blue-dim);padding:18px 20px}
.info-box.err{border-color:rgba(200,0,0,.15);background:rgba(200,0,0,.03)}
.info-box-title{font-family:var(--f-mono);font-size:.46rem;letter-spacing:.18em;text-transform:uppercase;margin-bottom:6px;color:var(--blue)}
.info-box.err .info-box-title{color:var(--red)}
.info-box-body{font-size:.72rem;line-height:1.9;color:rgba(10,10,10,.45)}
.info-box-body code{font-family:var(--f-mono);font-size:.65rem;background:rgba(10,10,10,.06);padding:2px 6px}

/* source chip */
.source-chip{font-family:var(--f-mono);font-size:.38rem;letter-spacing:.08em;border:1px solid var(--border);padding:2px 8px;color:rgba(10,10,10,.3)}
.source-chip.musinsa{border-color:rgba(26,86,255,.25);color:var(--blue);background:var(--blue-dim)}

/* success modal */
.modal-backdrop{position:fixed;inset:0;z-index:8000;background:rgba(10,10,10,.82);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
.modal-box{background:var(--bg);padding:52px 48px;max-width:480px;width:92%;border:1.5px solid var(--border);text-align:center}
.modal-check{font-family:var(--f-mono);font-size:.44rem;letter-spacing:.3em;color:var(--blue);text-transform:uppercase;margin-bottom:20px}
.modal-title{font-family:var(--f-disp);font-size:3rem;letter-spacing:.04em;margin-bottom:16px;line-height:1}
.modal-body{font-size:.8rem;line-height:2;color:rgba(10,10,10,.5);margin-bottom:28px}
.modal-close{font-family:var(--f-disp);font-size:.88rem;letter-spacing:.25em;color:#fff;background:var(--blue);border:none;padding:12px 44px;cursor:none;transition:opacity .2s}
.modal-close:hover{opacity:.85}

/* noise */
.noise{position:fixed;inset:0;z-index:1;pointer-events:none;opacity:.018;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");background-size:256px}
</style>
</head>
<body>
<div class="noise"></div>
<div id="cr"></div><div id="cd"></div>
<div id="reveal"></div>
<div id="trans"><div id="trans-lbl">SEOULFIT</div></div>

<header>
  <a class="hd-logo" href="index.html" data-href="index.html" data-label="SEOULFIT">SEOUL<em>FIT</em></a>
  <span class="hd-tag">K-POP 공항 패션 AI 추천</span>
  <button class="hd-back" data-href="index.html" data-label="SEOULFIT">← 메인으로</button>
</header>

<div class="hero">
  <div>
    <div style="font-family:var(--f-mono);font-size:.5rem;letter-spacing:.3em;color:var(--blue);text-transform:uppercase;margin-bottom:16px">K-POP IDOL AIRPORT FASHION</div>
    <h1 class="hero-title">AI 패션<br/><em>추천</em></h1>
    <div id="rate-badge">
      <span class="live-dot"></span>
      <span id="rate-text">환율 로딩 중...</span>
    </div>
  </div>
  <p class="hero-sub">K-POP 아이돌 공항 패션 기반 스타일 큐레이션. 무신사 실제 상품 데이터로 추천하며, 가격은 Yahoo Finance 실시간 환율로 엔화(¥) 변환됩니다.</p>
</div>

<div class="divider"></div>

<div class="section">
  <!-- ── 왼쪽: 입력 폼 ────────────────────────────────────── -->
  <div class="form-col">

    <!-- 이메일 -->
    <div class="email-wrap">
      <div class="f-label">이메일 주소 — 결제 완료 메일 수신</div>
      <input id="input-email" class="f-input" type="email" placeholder="your@email.com" autocomplete="email"/>
      <div class="email-note">결제 후 이 주소로 주문 확인 이메일이 발송됩니다</div>
    </div>

    <!-- 신체 정보 -->
    <div class="f-label">신체 정보</div>
    <div class="f-row">
      <input id="input-height" class="f-input" placeholder="키 (cm)" type="number" min="140" max="210"/>
      <input id="input-weight" class="f-input" placeholder="체중 (kg)" type="number" min="40" max="150"/>
    </div>

    <!-- 체형 -->
    <div class="f-label">체형</div>
    <div class="tag-group" id="tg-body">
      <button class="tag">마른 체형</button>
      <button class="tag on">표준</button>
      <button class="tag">근육형</button>
      <button class="tag">통통</button>
      <button class="tag">마른 비만</button>
    </div>

    <!-- 스타일 -->
    <div class="f-label">원하는 스타일</div>
    <div class="tag-group" id="tg-style">
      <button class="tag on">미니멀</button>
      <button class="tag">스트리트</button>
      <button class="tag">빈티지</button>
      <button class="tag">캐주얼</button>
      <button class="tag">포멀</button>
      <button class="tag">Y2K</button>
      <button class="tag">아메카지</button>
      <button class="tag">럭셔리 캐주얼</button>
    </div>

    <!-- 색상 -->
    <div class="f-label">선호 색상</div>
    <div class="tag-group" id="tg-color">
      <button class="tag on">블랙</button>
      <button class="tag">화이트</button>
      <button class="tag">베이지</button>
      <button class="tag">네이비</button>
      <button class="tag">카키</button>
      <button class="tag">그레이</button>
      <button class="tag">브라운</button>
      <button class="tag">멀티</button>
    </div>

    <!-- 예산 -->
    <div class="f-label">예산 (한화 기준 → 자동 엔화 변환)</div>
    <div class="tag-group" id="tg-budget">
      <button class="tag">~5만원</button>
      <button class="tag on">5~15만원</button>
      <button class="tag">15~30만원</button>
      <button class="tag">30만원+</button>
    </div>

    <button class="submit-btn" id="btn-submit">K-POP 스타일 AI 추천 받기 →</button>
  </div>

  <!-- ── 오른쪽: 결과 ──────────────────────────────────────── -->
  <div class="result-col" id="result-col">
    <div class="info-box">
      <div class="info-box-title">✦ 사용 방법</div>
      <div class="info-box-body">
        이메일과 체형 정보를 입력한 후 추천 버튼을 누르세요.<br/>
        무신사 실제 상품 이미지 & 데이터로 K-POP 공항 패션 스타일을 추천합니다.<br/>
        가격은 <strong>Yahoo Finance 실시간 KRW→JPY</strong> 환율로 자동 변환됩니다.
      </div>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════════════
   CONFIG
   EmailJS 설정: https://www.emailjs.com/
   1. 계정 생성 → Email Services에서 Gmail 추가
   2. Email Templates에서 템플릿 생성
      변수: {{to_email}}, {{brand_name}}, {{product_name}}, {{price_jpy}}, {{order_date}}
   3. 아래 세 값 입력
═══════════════════════════════════════════════════════════ */
const API_BASE    = 'http://localhost:8000';
const EMAILJS_SVC = 'YOUR_SERVICE_ID';
const EMAILJS_TPL = 'YOUR_TEMPLATE_ID';
const EMAILJS_KEY = 'YOUR_PUBLIC_KEY';

/* ── 상태 ──────────────────────────────────────────────── */
let exchangeRate = 0.0973;
let productStore = {};

/* ══ 커서 ══════════════════════════════════════════════════ */
const cr = document.getElementById('cr'), cd = document.getElementById('cd');
let mx = 0, my = 0, rx = 0, ry = 0;
document.addEventListener('mousemove', e => {
  mx = e.clientX; my = e.clientY;
  cd.style.left = mx + 'px'; cd.style.top = my + 'px';
});
(function loop() {
  rx += (mx - rx) * .11; ry += (my - ry) * .11;
  cr.style.left = rx + 'px'; cr.style.top = ry + 'px';
  requestAnimationFrame(loop);
})();
function applyCursor(root) {
  (root || document).querySelectorAll('a,button,.tag,.prod-card').forEach(el => {
    el.addEventListener('mouseenter', () => document.body.classList.add('ch'));
    el.addEventListener('mouseleave', () => document.body.classList.remove('ch'));
  });
}
applyCursor();

/* ══ 태그 토글 ══════════════════════════════════════════════ */
document.querySelectorAll('.tag-group').forEach(group => {
  const single = ['tg-body', 'tg-budget'].includes(group.id);
  group.querySelectorAll('.tag').forEach(t => {
    t.addEventListener('click', () => {
      if (single) { group.querySelectorAll('.tag').forEach(x => x.classList.remove('on')); }
      t.classList.toggle('on');
    });
  });
});

/* ══ 페이지 전환 ════════════════════════════════════════════ */
const trans = document.getElementById('trans');
function navTo(href, label) {
  document.getElementById('trans-lbl').textContent = label || 'SEOULFIT';
  trans.classList.add('go');
  setTimeout(() => window.location.href = href, 580);
}
document.querySelectorAll('[data-href]').forEach(el =>
  el.addEventListener('click', e => { e.preventDefault(); navTo(el.dataset.href, el.dataset.label); })
);

/* ══ 환율 (Yahoo Finance) ══════════════════════════════════ */
async function fetchExchangeRate() {
  try {
    const r = await fetch(`${API_BASE}/api/exchange-rate`);
    if (!r.ok) throw new Error();
    const d = await r.json();
    exchangeRate = d.krw_to_jpy;
    document.getElementById('rate-text').textContent =
      `1 KRW = ¥${exchangeRate.toFixed(4)}  ·  Yahoo Finance 실시간`;
  } catch {
    document.getElementById('rate-text').textContent =
      `1 KRW = ¥${exchangeRate.toFixed(4)}  ·  기본값 적용`;
  }
}
const krwToJpy = krw => Math.round(krw * exchangeRate);
const fmtJpy  = v  => `¥${v.toLocaleString('ja-JP')}`;

/* ══ 폼 제출 ════════════════════════════════════════════════ */
document.getElementById('btn-submit').addEventListener('click', async () => {
  const email  = document.getElementById('input-email').value.trim();
  const height = parseInt(document.getElementById('input-height').value) || null;
  const weight = parseInt(document.getElementById('input-weight').value) || null;

  if (!email) {
    alert('이메일 주소를 입력해주세요.');
    document.getElementById('input-email').focus();
    return;
  }

  const bodyType = [...document.querySelectorAll('#tg-body .tag.on')].map(t => t.textContent)[0] || '표준';
  const styles   = [...document.querySelectorAll('#tg-style .tag.on')].map(t => t.textContent);
  const colors   = [...document.querySelectorAll('#tg-color .tag.on')].map(t => t.textContent);
  const budget   = [...document.querySelectorAll('#tg-budget .tag.on')].map(t => t.textContent)[0] || '';

  showLoading();
  const btn = document.getElementById('btn-submit');
  btn.disabled = true;

  try {
    const r = await fetch(`${API_BASE}/api/recommend`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ height, weight, body_type: bodyType, styles, colors, budget_krw: budget, email }),
    });
    if (!r.ok) {
      const err = await r.json().catch(() => ({}));
      throw new Error(err.detail || '서버 오류');
    }
    const data = await r.json();
    renderResults(data, email);
  } catch (e) {
    showError(e.message);
  } finally {
    btn.disabled = false;
  }
});

/* ══ 로딩 스켈레톤 ══════════════════════════════════════════ */
function showLoading() {
  const col = document.getElementById('result-col');
  col.innerHTML = `
    <div style="margin-bottom:16px">
      <div class="skeleton" style="height:80px"></div>
    </div>
    ${[1,2,3].map(() => `
      <div class="prod-card" style="pointer-events:none">
        <div class="prod-inner">
          <div class="skeleton" style="width:96px;min-height:120px;flex-shrink:0"></div>
          <div style="flex:1;padding:14px;display:flex;flex-direction:column;gap:8px">
            <div class="skeleton" style="height:20px;width:60%"></div>
            <div class="skeleton" style="height:14px;width:80%"></div>
            <div class="skeleton" style="height:14px;width:90%"></div>
          </div>
        </div>
      </div>`).join('')}
    <div style="font-family:var(--f-mono);font-size:.44rem;letter-spacing:.18em;color:rgba(10,10,10,.28);text-align:center;margin-top:16px;animation:blink 1.5s infinite">
      무신사 상품 데이터 로딩 중 ...
    </div>`;
}

/* ══ 결과 렌더 ══════════════════════════════════════════════ */
function renderResults(data, email) {
  productStore = {};
  const krCnt  = data.korean_brands?.length  || 0;
  const otCnt  = data.other_brands?.length   || 0;
  const total  = krCnt + otCnt;
  const src    = data.source_korean === 'musinsa' ? 'musinsa' : 'ai';

  let html = `
    <div class="idol-banner">
      <div class="idol-banner-kw">
        <span>★</span>
        <span>${esc(data.idol_name || 'K-POP')} 스타일 레퍼런스</span>
        <span class="source-chip ${src}">${src === 'musinsa' ? '무신사 실제 상품' : 'AI 추천'}</span>
      </div>
      <div class="idol-banner-text">${esc(data.idol_style_ref || '')}</div>
    </div>

    <div class="r-header">
      <div class="r-title">추천 아이템</div>
      <div class="r-count">${total} ITEMS · ¥ JPY</div>
    </div>`;

  /* 한국 브랜드 (무신사) */
  if (krCnt) {
    html += `<div class="sec-label kr">▲ Korean Brands — 무신사 ${src === 'musinsa' ? '실제 상품' : 'AI Fallback'}</div>`;
    data.korean_brands.forEach((p, i) => { html += buildCard(p, true, `k${i}`, email); });
  }

  /* 해외 브랜드 */
  if (otCnt) {
    html += `<div class="sec-label other" style="margin-top:24px">○ Other Brands — AI 추천</div>`;
    data.other_brands.forEach((p, i) => { html += buildCard(p, false, `o${i}`, email); });
  }

  document.getElementById('result-col').innerHTML = html;
  applyCursor(document.getElementById('result-col'));
}

/* ── 카드 빌더 ─────────────────────────────────────────────── */
function buildCard(p, isKorean, uid, email) {
  const priceJpy = krwToJpy(p.price_krw || 0);
  const key = `prod_${uid}`;
  productStore[key] = {
    brand: p.brand, name: p.product_name,
    priceJpy, imageUrl: p.image_url || '',
    productUrl: p.product_url || '', email,
  };

  const tagsHtml = (p.style_tags || []).map(t => `<span class="prod-tag">${esc(t)}</span>`).join('');

  /* 이미지 영역 */
  let imgAreaHtml = '';
  if (isKorean && p.image_url) {
    /* 무신사 실제 이미지 */
    imgAreaHtml = `
      <div class="prod-img">
        <div class="kr-badge">KR</div>
        <div class="musinsa-badge">MUSINSA</div>
        <img src="${esc(p.image_url)}"
             alt="${esc(p.product_name)}"
             loading="lazy"
             onerror="this.parentElement.innerHTML='<div class=\\'prod-img-ph\\'>이미지<br/>없음</div>'"/>
      </div>`;
  } else if (isKorean) {
    /* 한국 브랜드지만 이미지 없음 */
    imgAreaHtml = `
      <div class="prod-img">
        <div class="kr-badge">KR</div>
        <div class="prod-img-ph">무신사<br/>이미지<br/>없음</div>
      </div>`;
  } else {
    /* 해외 브랜드 — 브랜드 이니셜 플레이스홀더 */
    const initials = (p.brand || 'BR').split(/\s+/).map(w => w[0]).join('').slice(0, 2).toUpperCase();
    imgAreaHtml = `
      <div class="brand-initial">
        ${esc(initials)}
        <small>global</small>
      </div>`;
  }

  /* 무신사 링크 버튼 (한국 브랜드만) */
  const viewBtn = (isKorean && p.product_url)
    ? `<a class="prod-view" href="${esc(p.product_url)}" target="_blank" rel="noopener" title="무신사에서 보기">무신사<br/>↗</a>`
    : '';

  return `
    <div class="prod-card">
      <div class="prod-inner">
        ${imgAreaHtml}
        <div class="prod-body">
          <div>
            <div class="prod-brand">${esc(p.brand)}</div>
            <div class="prod-name">${esc(p.product_name)}</div>
            <div class="prod-desc">${esc(p.product_description || '')}</div>
            <div class="prod-tags">${tagsHtml}</div>
          </div>
        </div>
        <div class="prod-price-col">
          <div>
            <div class="prod-price-jpy">${fmtJpy(priceJpy)}</div>
            <div class="prod-price-krw">≈ ${(p.price_krw || 0).toLocaleString()}원</div>
          </div>
        </div>
      </div>
      <div class="prod-buy-bar">
        <button class="prod-buy" onclick="purchaseProduct('${key}')">
          구매하기
          <span>Stripe · カード / コンビニ →</span>
        </button>
        ${viewBtn}
      </div>
    </div>`;
}

/* ══ 구매 (Stripe Checkout) ════════════════════════════════ */
async function purchaseProduct(key) {
  const p = productStore[key];
  if (!p) return;
  if (!p.email) { alert('이메일 주소를 입력해주세요.'); return; }

  const btn = event?.target?.closest('.prod-buy');
  const origHtml = btn?.innerHTML || '';
  if (btn) { btn.textContent = '결제 페이지 이동 중...'; btn.disabled = true; }

  try {
    const r = await fetch(`${API_BASE}/api/checkout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        product_name: p.name,
        brand: p.brand,
        price_jpy: p.priceJpy,
        image_url: p.imageUrl || undefined,
        product_url: p.productUrl || undefined,
        email: p.email,
      }),
    });
    if (!r.ok) {
      const err = await r.json().catch(() => ({}));
      throw new Error(err.detail || '결제 서버 오류');
    }
    const d = await r.json();
    if (d.checkout_url) window.location.href = d.checkout_url;
  } catch (e) {
    alert(`결제 오류: ${e.message}\n\n백엔드 서버가 실행 중인지 확인해주세요.`);
    if (btn) { btn.innerHTML = origHtml; btn.disabled = false; }
  }
}

/* ══ 결제 완료 처리 ══════════════════════════════════════════ */
function checkPaymentSuccess() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('payment') !== 'success') return;

  const email   = decodeURIComponent(params.get('email')   || '');
  const product = decodeURIComponent(params.get('product') || '');
  const brand   = decodeURIComponent(params.get('brand')   || '');
  const price   = parseInt(params.get('price') || '0');

  showSuccessModal(email, product, brand, price);
  sendConfirmationEmail(email, product, brand, price);
  window.history.replaceState({}, '', window.location.pathname);
}

function showSuccessModal(email, product, brand, price) {
  const bd = document.createElement('div');
  bd.className = 'modal-backdrop';
  bd.innerHTML = `
    <div class="modal-box">
      <div class="modal-check">✓ Payment Complete · お支払い完了</div>
      <div class="modal-title">결제 완료</div>
      <div class="modal-body">
        <strong>${esc(brand)}</strong><br/>
        ${esc(product)}<br/>
        <span style="font-family:var(--f-disp);font-size:1.6rem;color:var(--blue)">${fmtJpy(price)}</span><br/><br/>
        <span style="font-size:.72rem">${esc(email)}<br/>으로 확인 이메일을 발송했습니다</span>
      </div>
      <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">닫기</button>
    </div>`;
  document.body.appendChild(bd);
  applyCursor(bd);
}

async function sendConfirmationEmail(email, product, brand, price) {
  if (typeof emailjs === 'undefined' || EMAILJS_KEY === 'YOUR_PUBLIC_KEY') {
    console.warn('[EmailJS] CONFIG에서 SERVICE_ID / TEMPLATE_ID / PUBLIC_KEY를 설정해주세요.');
    return;
  }
  try {
    emailjs.init(EMAILJS_KEY);
    await emailjs.send(EMAILJS_SVC, EMAILJS_TPL, {
      to_email:     email,
      brand_name:   brand,
      product_name: product,
      price_jpy:    fmtJpy(price),
      order_date:   new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' }),
    });
    console.log('[EmailJS] 확인 이메일 발송 완료');
  } catch (e) {
    console.error('[EmailJS] 발송 실패:', e);
  }
}

/* ── 오류 표시 ─────────────────────────────────────────────── */
function showError(msg) {
  document.getElementById('result-col').innerHTML = `
    <div class="info-box err">
      <div class="info-box-title">⚠ 오류</div>
      <div class="info-box-body">
        ${esc(msg || '알 수 없는 오류')}<br/><br/>
        백엔드 서버가 실행 중인지 확인:<br/>
        <code>cd backend && uvicorn main:app --reload</code>
      </div>
    </div>`;
}

/* ── HTML 이스케이프 ────────────────────────────────────────── */
function esc(s) {
  if (!s) return '';
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/* ══ 초기화 ════════════════════════════════════════════════ */
window.addEventListener('DOMContentLoaded', () => {
  fetchExchangeRate();
  checkPaymentSuccess();
});
</script>
</body>
</html>
